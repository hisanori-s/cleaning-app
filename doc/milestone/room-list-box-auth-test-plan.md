# RoomListBox認証連携 テスト実装計画

> **重要**: 
> - 既存の基本機能テストは維持したまま、認証連携のテストを追加
> - テストと実装の変更は`src/__tests__`ディレクトリ内に限定
> - モックデータのハードコーディングは厳禁
> - WPエンドポイントでユーザーIDに基づく物件フィルタリングを行う（実装はコメントアウトで準備）

## 1. 要件整理

### テスト対象
- `RoomListBox`コンポーネントと認証機能の連携
- `useAuth` hookとの統合
- モックデータの表示検証

### テスト要件
1. 認証状態による表示制御
   - 認証済みユーザーの場合のみWPエンドポイントにアクセス
   - 未認証時は適切なメッセージを表示
   - ログアウト時の表示クリア

2. モックデータの表示
   - `properties-rooms.json`の内容をそのまま表示
   - モックデータの全項目が正しく表示されること
   - データの順序が保持されていること

3. データ表示の検証
   - 取得した部屋一覧の正常表示
   - エッジケース（データなし）の処理
   - ローディング状態の表示

## 2. 作業マイルストーン

### Phase 1: テスト環境整備
- [ ] 認証テスト用の環境設定
  - [ ] `auth.json`モックデータの確認
  - [ ] テスト用の認証ヘルパー関数の作成
  - [ ] 認証状態のモック方法の確立
- [ ] テストユーティリティの準備
  - [ ] `properties-rooms.json`の読み込み確認
  - [ ] カスタムレンダラーの拡張
  - [ ] テストヘルパー関数の実装

### Phase 2: 認証状態テストの実装
- [ ] 認証状態別の表示テスト
  - [ ] 認証済み状態でのモックデータ表示確認
  - [ ] 未認証状態での表示確認
  - [ ] ログアウト時の表示確認
- [ ] エラーハンドリングテスト
  - [ ] 認証エラー時の表示確認
  - [ ] セッション切れ時の表示確認
  - [ ] ネットワークエラー時の表示確認

### Phase 3: モックデータ表示テストの実装
- [ ] データ表示テスト
  - [ ] モックデータの全項目表示確認
  - [ ] データ順序の保持確認
  - [ ] 表示形式の検証
- [ ] エッジケーステスト
  - [ ] データなし時の表示確認
  - [ ] エラーメッセージの表示確認

### Phase 4: 統合テストの実装
- [ ] 認証・データ表示の統合テスト
  - [ ] ログイン→データ表示→ログアウトのフロー確認
  - [ ] 認証状態変更時の表示更新確認
  - [ ] エラー発生時のリカバリー確認
- [ ] パフォーマンステスト
  - [ ] 大量データ時の表示性能確認
  - [ ] メモリリーク確認
  - [ ] 再レンダリング最適化確認

### Phase 5: リファクタリングとドキュメント
- [ ] コードのリファクタリング
  - [ ] テストコードの重複排除
  - [ ] テストケースの整理
  - [ ] 命名の改善
- [ ] ドキュメントの更新
  - [ ] テストケースの説明追加
  - [ ] セットアップ手順の更新
  - [ ] トラブルシューティングガイドの作成

## 3. 注意事項
1. 既存の基本機能テストは維持すること
2. 認証状態の変更は必ずテストヘルパーを通じて行うこと
3. モックデータは`src/__tests__/mocks/api`ディレクトリで管理
4. テストの独立性を保つため、各テスト実行前に認証状態をリセット
5. 非同期処理のテストは適切なアサーションを使用
6. エラー情報は日本語で詳細に記述
7. テストカバレッジは80%以上を維持

## 4. 技術的考慮事項
- テストフレームワーク: Vitest
- UIテストライブラリ: React Testing Library
- 認証管理: useAuth Hook
- モックデータ: JSONファイルベース（`properties-rooms.json`）

## 5. 完了条件
- [ ] すべてのテストケースが実装され、パスすること
- [ ] カバレッジが80%以上であること
- [ ] エラーハンドリングが適切に実装されていること
- [ ] 認証状態の変更が正しく反映されること
- [ ] モックデータが正しく表示されること
- [ ] パフォーマンスが要件を満たしていること
- [ ] ドキュメントが更新され、メンテナンス性が確保されていること

## 6. 実装メモ
```typescript
// TODO: 認証情報をベースにした物件取得のコード（将来実装用）
// src/api/wordpress.tsで実装

const fetchRooms = async (userId: number) => {
  try {
    // WPエンドポイントにユーザーIDを送信してフィルタリング
    const response = await fetch(`${API_BASE_URL}/properties?user_id=${userId}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });
    
    if (!response.ok) {
      throw new Error('物件情報の取得に失敗しました');
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('【エラー詳細】:', {
      説明: '物件情報取得時にエラーが発生しました',
      場所: 'fetchRooms関数',
      エラー: error.message
    });
    throw error;
  }
};
```

## 7. 将来の拡張計画
- ユーザーIDによるフィルタリング機能の実装
- WPエンドポイントの実装と連携
- パフォーマンス最適化
- エラーハンドリングの強化 