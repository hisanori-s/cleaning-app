# RoomListBoxコンポーネント テスト実装計画

> **重要**: 
> - 各フェーズの作業は慎重に進め、変更の影響範囲を十分に確認しながら実施すること。
> - 特に環境変数の移行は、既存のテストへの影響を考慮しながらゆっくりと進める。
> - モックデータのハードコーディングは厳禁。すべてのモックデータは`src/__tests__/mocks/api/`配下のJSONファイルで管理すること。

## 1. 要件整理

### テスト対象コンポーネント
- `RoomListBox`コンポーネント（`src/components/dashboard/room-list-box/room-list-box.tsx`）

### テスト要件
1. データ表示要件
   - 物件名（property_name）
   - 部屋番号（room_number）
   - 空室予定日（vacancy_date）
   - 清掃期限（cleaning_deadline）
   - ユーザーに許可された物件IDに紐づく部屋情報のみ表示

2. モックデータ要件
   - テストディレクトリ内にモックデータを移行
   - 移行完了後、既存のモックデータ（`WPplugin/mock-api-return`）を削除
   - スケルトン段階では本番環境もテストディレクトリのモックデータを利用
   - 認証情報を含むすべてのモックデータをテストディレクトリで一元管理

## 2. 作業マイルストーン

### Phase 0: テスト環境の移行準備
- [x] 環境変数管理方式の変更
  - [x] `.env.test`ファイルの作成と設定
  - [x] `vitest.config.ts`の環境変数設定の追加
  - [x] `setup.ts`からの環境変数設定の移行
  - [x] 本番環境用の環境変数設定の調整
- [x] 認証テストの依存関係の確認と修正
  - [x] 認証テストでの環境変数参照箇所の特定
  - [x] 影響範囲の調査と修正計画の作成
  - [x] テストコードの修正
- [x] テスト環境ガイドラインの更新
  - [x] 環境変数管理に関する記述の修正
  - [x] 新しい方式に関するベストプラクティスの追加
  - [x] 移行手順と注意点の追記
  - [x] モックデータの取り扱いに関する記述の更新

### Phase 1: テスト環境整備
- [x] モックデータの移行準備
  - [x] `src/__tests__/mocks/api/`ディレクトリの作成
  - [x] モックデータの移行計画の作成
    - [x] 移行対象ファイルの特定
      - `properties-rooms.json`（優先度：高）
      - `room-detail.json`（優先度：中）
      - `reports.json`（優先度：低）
    - [x] 依存関係の確認
      - `auth.json`: 認証関連のテストで使用（移行済み）
      - `properties-rooms.json`: 部屋一覧表示、RoomListBoxコンポーネントで使用
      - `room-detail.json`: 部屋詳細表示機能で使用
      - `reports.json`: 清掃レポート機能で使用
    - [x] 移行手順の詳細化
      1. `properties-rooms.json`の移行とテスト
      2. `room-detail.json`の移行とテスト
      3. `reports.json`の移行とテスト
      4. 参照パスの更新と動作確認
      5. 既存データの削除
- [x] モックデータの移行
  - [x] `properties-rooms.json`の移行
  - [x] `room-detail.json`の移行
  - [x] `reports.json`の移行
- [x] 環境設定の更新
  - [x] 相対パスでのモックデータ参照設定
    - [x] `.env.test`の`VITE_MOCK_API_BASE_URL`を相対パスに変更
    - [x] パス参照の動作確認
  - [x] テストコードでのパス参照更新

### Phase 2: 型定義の整備
- [x] Room型の定義
  - [x] `src/types/room.ts`の作成または更新
  - [x] プロパティの型定義
    - `property_id`: number
    - `property_name`: string
    - `room_number`: string
    - `vacancy_date`: string (ISO 8601形式)
    - `cleaning_deadline`: string (ISO 8601形式)
    - `status`: 'urgent' | 'normal' | 'overdue'
  - [x] 関連する型定義の確認と更新
- [x] テスト用のモックデータ型定義
  - [x] `src/__tests__/mocks/types.ts`の作成
  - [x] モックデータの型安全性の確保

### Phase 3: 動作確認とクリーンアップ
- [ ] テスト実行による動作確認
  - [ ] 開発サーバー未起動でのテスト実行確認
  - [ ] テスト環境での動作確認
  - [ ] 開発環境での動作確認
  - [ ] ハードコーディングされたモックデータの削除
  - [ ] JSONファイルからのモックデータ読み込みの確認
- [ ] 既存モックデータの削除
  - [ ] すべてのテストが新しいモックデータで成功することを確認
  - [ ] `WPplugin/mock-api-return`のデータを削除

### Phase 4: テストケース実装
- [ ] RoomListBoxコンポーネントのテストファイル作成
  - `src/__tests__/components/dashboard/room-list-box/room-list-box.test.tsx`
  - テストユーティリティの準備
- [ ] テストケースの実装
  1. 正常系
     - 許可された物件の部屋一覧が表示されること
     - 各部屋情報（物件名、部屋番号、日付）が正しく表示されること
     - データの並び順が正しいこと
  2. 異常系
     - 許可されていない物件の部屋が表示されないこと
     - データが空の場合の挙動
     - 不正なデータ形式の場合の挙動
     - ネットワークエラー時の挙動

### Phase 5: リファクタリングとドキュメント
- [ ] テストコードのリファクタリング
  - 重複コードの排除
  - テストケースの整理
- [ ] テストヘルパー関数の作成
  - 共通のセットアップ処理
  - カスタムマッチャー（必要な場合）
- [ ] デバッグ情報の追加
  - コンソール出力の日本語化
  - エラー発生時の詳細情報表示
  - テストカバレッジレポートの設定

## 3. 注意事項
1. モックデータの移行は段階的に行い、各段階で動作確認を実施
2. テストと実装の変更は`src/__tests__`ディレクトリ内に限定
3. テストの独立性を保つため、各テストケース実行前にステートをリセット
4. 非同期処理のテストは適切なアサーションを使用
5. デバッグ情報は日本語で記述し、詳細な情報を提供
6. 環境変数の移行は既存のテストへの影響を慎重に確認
7. 各フェーズでの変更は十分なテストと確認を行ってから次に進む
8. モックデータの移行後は参照パスの変更漏れがないか確認
9. モックデータには必ず目的と用途を示すドキュメントコメントを含める
10. 環境変数でのパス指定は可能な限り相対パスを使用

## 4. 技術的考慮事項
- テストフレームワーク: Vitest
- UIテストライブラリ: React Testing Library
- エラーハンドリング: ErrorBoundaryの活用
- 環境変数: `.env.test`による一元管理
- モックデータ: テストディレクトリでの一元管理

## 5. 完了条件
- [ ] すべてのテストケースが実装され、パスすること
- [ ] カバレッジが80%以上であること
- [ ] リファクタリングが完了していること
- [ ] デバッグ情報が適切に実装されていること
- [ ] 環境変数の移行が完了し、すべてのテストが正常に動作すること
- [ ] テスト環境ガイドラインが更新され、新しい方式が反映されていること
- [ ] モックデータの移行が完了し、すべての参照が新しいパスに更新されていること
- [ ] 開発環境でもテストディレクトリのモックデータを正しく参照できること 